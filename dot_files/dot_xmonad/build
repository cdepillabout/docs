#!/usr/bin/env bash

function die ()
{
	local msg="${1}"
	echo "${msg}" >&2
    exit 1
}

cd ~/.xmonad

source ./xmonad_build_vars.sh

if [ "$?" -ne 0 ] ; then
	die "Failed to source the xmonad_build_vars.sh file."
fi

mkdir -p "${XMONAD_LOCAL_BIN_PATH}"

# This is for taffybar.
PATH="${XMONAD_LOCAL_BIN_PATH}:${PATH}" stack install \
	--resolver "${XMONAD_STACK_RESOLVER}" \
	--local-bin-path "${XMONAD_LOCAL_BIN_PATH}" \
	gtk2hs-buildtools \

if [ "$?" -ne 0 ] ; then
	die "Failed to install gtk2hs-buildtools (for taffybar)."
fi

PATH="${XMONAD_LOCAL_BIN_PATH}:${PATH}" stack install \
	--resolver "${XMONAD_STACK_RESOLVER}" \
	--local-bin-path "${XMONAD_LOCAL_BIN_PATH}" \
	dbus \
	gtk-traymanager \
	libxml-sax \
	taffybar

if [ "$?" -ne 0 ] ; then
	die "Failed to install taffybar."
fi

PATH="${XMONAD_LOCAL_BIN_PATH}:${PATH}" stack ghc \
	--resolver "${XMONAD_STACK_RESOLVER}" \
	--package dbus \
	--package gtk-traymanager \
	--package libxml-sax \
	--package taffybar \
	--package xmonad \
	--package xmonad-contrib \
	-- --make xmonad.hs -i -ilib -fforce-recomp -main-is main -o "${1}"
